# 交互式日志记录解决方案

## 🎯 问题分析

### 原始问题
当使用 `tee` 命令将输出同时重定向到控制台和日志文件时，会导致交互式输入失效：

```bash
# 这种方式会导致交互失效
"$TEST_BUILD_DIR/$APP_NAME" 2>&1 | tee -a "$TEST_LOG_FILE"
```

**原因**：`tee` 命令会缓冲输入输出，导致程序无法正确检测到用户的交互式输入。

## ✅ 解决方案

### 方案设计
使用分层处理方式，根据不同的运行模式采用不同的日志策略：

1. **自动化模式** (`--record`, `--no-record`)：直接使用管道输入 + `tee`
2. **交互式模式** (默认)：使用临时文件缓存，保持交互性

### 具体实现

```bash
case "$RECORD_TEST" in
    "yes")
        # 自动化模式：自动进行录制测试
        echo "y" | "$TEST_BUILD_DIR/$APP_NAME" 2>&1 | tee -a "$TEST_LOG_FILE"
        ;;
    "no")
        # 自动化模式：跳过录制测试
        echo "n" | "$TEST_BUILD_DIR/$APP_NAME" 2>&1 | tee -a "$TEST_LOG_FILE"
        ;;
    *)
        # 交互式模式：保持用户交互，后续记录日志
        echo "🔄 运行交互式测试..."
        
        # 使用临时文件保存输出
        TEMP_LOG=$(mktemp)
        "$TEST_BUILD_DIR/$APP_NAME" 2>&1 | tee "$TEMP_LOG"
        
        # 将临时文件内容追加到正式日志
        cat "$TEMP_LOG" >> "$TEST_LOG_FILE"
        rm "$TEMP_LOG"
        ;;
esac
```

## 🧪 测试验证

### 1. 自动化模式测试
```bash
# 跳过录制测试 - 不会卡住
./scripts/test_sdk.sh --no-record

# 自动录制测试 - 不会卡住
./scripts/test_sdk.sh --record
```

### 2. 交互式模式测试
```bash
# 交互式询问 - 可以正常输入
./scripts/test_sdk.sh

# 通过管道模拟用户输入 - 也能正常工作
echo "y" | ./scripts/test_sdk.sh
```

## 📊 测试结果

### 成功的交互式录制测试
```
❓ 是否进行实际录制测试？(需要麦克风权限)
输入 'y' 或 'yes' 进行实际录制测试，其他任意键跳过:

🎬 开始实际录制测试 (时长: 3.0 秒)...
  🎤 测试麦克风录制...
  📊 检测到音频信号: 0.34
  📊 检测到音频信号: 0.42
  ...
  ✅ 录制完成:
    - 文件名: 麦克风_20251028-182332.wav
    - 时长: 00:03
    - 大小: 618 KB
    - 模式: 麦克风
```

### 完整的日志记录
- ✅ 控制台实时显示
- ✅ 完整日志文件保存
- ✅ 交互式输入正常工作
- ✅ 音频录制成功完成

## 🔧 技术细节

### 临时文件处理
```bash
# 创建临时文件
TEMP_LOG=$(mktemp)

# 运行程序，输出到控制台和临时文件
"$TEST_BUILD_DIR/$APP_NAME" 2>&1 | tee "$TEMP_LOG"

# 将临时文件内容追加到正式日志
cat "$TEMP_LOG" >> "$TEST_LOG_FILE"

# 清理临时文件
rm "$TEMP_LOG"
```

### 优势
1. **保持交互性**：程序可以正常接收用户输入
2. **完整日志**：所有输出都被记录到日志文件
3. **实时显示**：用户可以看到实时的测试进度
4. **自动清理**：临时文件自动删除，不留垃圾

## 📋 使用指南

### 开发调试
```bash
# 快速测试（无交互）
./scripts/test_sdk.sh --no-record

# 完整测试（无交互）
./scripts/test_sdk.sh --record

# 交互式测试（可以选择是否录制）
./scripts/test_sdk.sh
```

### CI/CD 集成
```bash
# 自动化脚本中使用
./scripts/test_sdk.sh --no-record
if [ $? -eq 0 ]; then
    echo "✅ SDK 测试通过"
else
    echo "❌ SDK 测试失败"
    # 查看日志文件
    cat test_logs/$(ls -t test_logs/sdk_test_*.log | head -1)
    exit 1
fi
```

### 日志管理
```bash
# 查看测试日志
./scripts/view_test_logs.sh

# 直接查看最新日志
cat test_logs/$(ls -t test_logs/sdk_test_*.log | head -1)
```

## 🎉 解决效果

### 问题解决状态
- ✅ **交互式输入正常**：用户可以正常输入 y/n
- ✅ **日志完整记录**：所有输出都保存到日志文件
- ✅ **实时显示保持**：控制台实时显示测试进度
- ✅ **自动化兼容**：支持 CI/CD 自动化使用
- ✅ **录制功能正常**：实际录制测试成功完成

### 性能指标
- **录制时长**：3秒
- **生成文件**：618KB WAV 文件
- **音频质量**：48kHz, 单声道, Float32
- **日志大小**：8.0K 完整日志

### 用户体验
- 🎯 **清晰的提示**：明确告知用户当前模式
- 📊 **实时反馈**：显示音频电平和录制进度
- 📝 **完整记录**：所有操作都有日志可查
- 🚀 **快速选择**：三种模式满足不同需求

## 💡 最佳实践

### 1. 日常开发
- 使用 `--no-record` 进行快速验证
- 使用交互式模式进行完整测试
- 定期查看日志文件排查问题

### 2. 自动化测试
- CI/CD 中使用 `--no-record` 或 `--record`
- 设置适当的超时时间
- 保存日志文件用于问题排查

### 3. 问题排查
- 查看完整日志文件
- 对比不同时间的测试结果
- 关注音频设备和权限状态

现在的解决方案完美平衡了交互性、日志记录和自动化需求！🎉
