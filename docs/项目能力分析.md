# å½•éŸ³å·¥ç¨‹å®é™…èƒ½åŠ›åˆ†æ

## ğŸ¯ å®é™…å½•åˆ¶èƒ½åŠ›æ€»ç»“

æ ¹æ®ä»£ç åˆ†æï¼Œä½ çš„å½•éŸ³å·¥ç¨‹ç¡®å®æä¾›äº†ä»¥ä¸‹å½•åˆ¶èƒ½åŠ›ï¼š

### 1. **å½•åˆ¶æ¨¡å¼æšä¸¾**
```swift
enum RecordingMode: String, CaseIterable {
    case microphone = "microphone"        // éº¦å…‹é£å½•åˆ¶
    case specificProcess = "specificProcess"  // ç‰¹å®šè¿›ç¨‹å½•åˆ¶
    case systemMixdown = "systemMixdown"     // ç³»ç»Ÿæ··éŸ³å½•åˆ¶
}
```

### 2. **å½•åˆ¶å™¨å®ç°**

#### A. **MicrophoneRecorder** - çº¯éº¦å…‹é£å½•åˆ¶
```swift
class MicrophoneRecorder: BaseAudioRecorder {
    private let engine = AVAudioEngine()
    private let recordMixer = AVAudioMixerNode()
    // ä½¿ç”¨ AVAudioEngine å½•åˆ¶éº¦å…‹é£
}
```

#### B. **CoreAudioProcessTapRecorder** - ç³»ç»ŸéŸ³é¢‘å½•åˆ¶
```swift
@available(macOS 14.4, *)
class CoreAudioProcessTapRecorder: BaseAudioRecorder {
    private var targetPID: pid_t?  // æ”¯æŒç‰¹å®šè¿›ç¨‹
    // ä½¿ç”¨ CoreAudio Process Tap å½•åˆ¶ç³»ç»ŸéŸ³é¢‘
}
```

#### C. **MixedAudioRecorder** - èåˆå½•åˆ¶ â­ï¸
```swift
@available(macOS 14.4, *)
class MixedAudioRecorder: BaseAudioRecorder {
    // ç³»ç»ŸéŸ³é¢‘å½•åˆ¶ç»„ä»¶ (Process Tap)
    private var processTapManager: ProcessTapManager?
    
    // éº¦å…‹é£å½•åˆ¶ç»„ä»¶ (AVAudioEngine)
    private let micEngine = AVAudioEngine()
    
    // æ··éŸ³ç¼“å†²åŒº - ä½¿ç”¨ç¯å½¢ç¼“å†²åŒºå­˜å‚¨éº¦å…‹é£æ•°æ®
    private var micRingBuffer: [Float] = []
}
```

## ğŸ”„ å½•åˆ¶æ¨¡å¼å¯¹åº”å…³ç³»

### ä¸æˆ‘ä»¬è®¾è®¡çš„ MediaStream æ¶æ„å¯¹æ¯”

| å®é™…å·¥ç¨‹ | æˆ‘ä»¬çš„è®¾è®¡ | è½¨é“ç»„åˆ | è¯´æ˜ |
|---------|-----------|---------|------|
| `microphone` | `microphoneOnly` | 1ä¸ªéº¦å…‹é£è½¨é“ | âœ… å®Œå…¨åŒ¹é… |
| `systemMixdown` | `systemAudioOnly` | 1ä¸ªç³»ç»Ÿæ··éŸ³è½¨é“ | âœ… å®Œå…¨åŒ¹é… |
| `specificProcess` | `systemAudioOnly` | 1ä¸ªè¿›ç¨‹è½¨é“ | âœ… å®Œå…¨åŒ¹é… |
| `mixAudio=true` | `mixedAudio` | éº¦å…‹é£è½¨é“+ç³»ç»Ÿè½¨é“ | âœ… å®Œå…¨åŒ¹é… |

## ğŸ“Š å®é™…å½•åˆ¶èƒ½åŠ›è¯¦è§£

### 1. **çº¯éº¦å…‹é£å½•åˆ¶**
```swift
// å¯¹åº” AudioMediaStream è®¾è®¡ä¸­çš„ï¼š
let stream = AudioMediaStream()
let micTrack = AudioMediaStreamTrack(
    type: .microphone,
    source: .device(deviceId: "default"),
    format: AudioFormat.standard48kHz
)
stream.addTrack(micTrack)
// recordingMode = .microphoneOnly
```

**å®é™…å®ç°ï¼š**
- ä½¿ç”¨ `MicrophoneRecorder`
- åŸºäº `AVAudioEngine`
- æ”¯æŒå›å£°æ¶ˆé™¤ã€é™å™ªç­‰å¤„ç†

### 2. **ç³»ç»ŸéŸ³é¢‘å½•åˆ¶**
```swift
// å¯¹åº” AudioMediaStream è®¾è®¡ä¸­çš„ï¼š
let stream = AudioMediaStream()
let systemTrack = AudioMediaStreamTrack(
    type: .systemOutput,  // æˆ– .processOutput
    source: .systemMixdown,  // æˆ– .process(pid, name)
    format: AudioFormat.standard48kHz
)
stream.addTrack(systemTrack)
// recordingMode = .systemAudioOnly
```

**å®é™…å®ç°ï¼š**
- ä½¿ç”¨ `CoreAudioProcessTapRecorder`
- åŸºäº `CoreAudio Process Tap` (macOS 14.4+)
- æ”¯æŒç³»ç»Ÿæ··éŸ³å’Œç‰¹å®šè¿›ç¨‹å½•åˆ¶

### 3. **æ··åˆå½•åˆ¶ï¼ˆèåˆå½•éŸ³ï¼‰**
```swift
// å¯¹åº” AudioMediaStream è®¾è®¡ä¸­çš„ï¼š
let stream = AudioMediaStream()

// æ·»åŠ éº¦å…‹é£è½¨é“
let micTrack = AudioMediaStreamTrack(type: .microphone, ...)
stream.addTrack(micTrack)

// æ·»åŠ ç³»ç»ŸéŸ³é¢‘è½¨é“
let systemTrack = AudioMediaStreamTrack(type: .systemOutput, ...)
stream.addTrack(systemTrack)

// recordingMode = .mixedAudio
```

**å®é™…å®ç°ï¼š**
- ä½¿ç”¨ `MixedAudioRecorder`
- åŒæ—¶ä½¿ç”¨ `ProcessTap` + `AVAudioEngine`
- ç¯å½¢ç¼“å†²åŒºå®ç°éŸ³é¢‘åŒæ­¥
- å®æ—¶æ··éŸ³åˆ°å•ä¸ªæ–‡ä»¶

## ğŸ›ï¸ æ§åˆ¶é€»è¾‘åˆ†æ

### AudioRecorderController çš„å½•åˆ¶é€»è¾‘
```swift
func startMultiSourceRecording(
    wantMic: Bool,           // æ˜¯å¦å½•åˆ¶éº¦å…‹é£
    wantSystem: Bool,        // æ˜¯å¦å½•åˆ¶ç³»ç»ŸéŸ³é¢‘
    wantProcess: Bool,       // æ˜¯å¦å½•åˆ¶ç‰¹å®šè¿›ç¨‹
    targetPID: pid_t? = nil, // ç‰¹å®šè¿›ç¨‹PID
    mixAudio: Bool = false   // æ˜¯å¦æ··éŸ³å½•åˆ¶
) {
    // å¦‚æœå¯ç”¨æ··éŸ³æ¨¡å¼
    if mixAudio && (wantSystem || wantProcess) {
        startMixedRecording(...)  // ä½¿ç”¨ MixedAudioRecorder
        return
    }
    
    // å¦åˆ™åˆ›å»ºç‹¬ç«‹çš„å½•åˆ¶å™¨
    if wantMic { /* åˆ›å»º MicrophoneRecorder */ }
    if wantSystem { /* åˆ›å»º CoreAudioProcessTapRecorder */ }
    if wantProcess { /* åˆ›å»º CoreAudioProcessTapRecorder */ }
}
```

### UI æ§åˆ¶é€»è¾‘
```swift
// MainViewController ä¸­çš„é€»è¾‘
let actualWantMic = shouldMixAudio ? false : wantMic  // æ··éŸ³æ¨¡å¼ä¸‹ä¸éœ€è¦å•ç‹¬çš„éº¦å…‹é£è½¨é“

audioRecorderController?.startMultiSourceRecording(
    wantMic: actualWantMic,
    wantSystem: wantSystemMixdown,
    wantProcess: wantSpecificProcess,
    targetPID: selectedPIDs.first,
    mixAudio: shouldMixAudio
)
```

## ğŸ¯ ä¸è®¾è®¡æ¶æ„çš„å®Œç¾åŒ¹é…

### æˆ‘ä»¬çš„ MediaStream è®¾è®¡å®Œå…¨ç¬¦åˆå®é™…å·¥ç¨‹ï¼š

1. **è½¨é“ç±»å‹æ˜ å°„**ï¼š
   - `microphone` â†’ `AudioTrackType.microphone`
   - `systemMixdown` â†’ `AudioTrackType.systemOutput`
   - `specificProcess` â†’ `AudioTrackType.processOutput`

2. **å½•åˆ¶æ¨¡å¼æ˜ å°„**ï¼š
   - å•ç‹¬å½•åˆ¶ â†’ `RecordingMode.microphoneOnly` æˆ– `systemAudioOnly`
   - æ··åˆå½•åˆ¶ â†’ `RecordingMode.mixedAudio`

3. **è½¨é“ç»„åˆé€»è¾‘**ï¼š
   ```swift
   var recordingMode: RecordingMode {
       let hasMic = !getMicrophoneTracks().isEmpty
       let hasSystem = !getSystemOutputTracks().isEmpty || !getProcessOutputTracks().isEmpty
       
       switch (hasMic, hasSystem) {
       case (true, false): return .microphoneOnly
       case (false, true): return .systemAudioOnly  
       case (true, true): return .mixedAudio
       case (false, false): return .inactive
       }
   }
   ```

## ğŸ“‹ åŠŸèƒ½å¯¹ç…§è¡¨

| åŠŸèƒ½ | å®é™…å·¥ç¨‹ | æˆ‘ä»¬çš„è®¾è®¡ | åŒ¹é…åº¦ |
|------|---------|-----------|--------|
| éº¦å…‹é£å½•åˆ¶ | âœ… MicrophoneRecorder | âœ… microphone è½¨é“ | 100% |
| ç³»ç»ŸéŸ³é¢‘å½•åˆ¶ | âœ… CoreAudioProcessTapRecorder | âœ… systemOutput è½¨é“ | 100% |
| ç‰¹å®šè¿›ç¨‹å½•åˆ¶ | âœ… CoreAudioProcessTapRecorder + PID | âœ… processOutput è½¨é“ | 100% |
| æ··åˆå½•åˆ¶ | âœ… MixedAudioRecorder | âœ… mixedAudio æ¨¡å¼ | 100% |
| åŠ¨æ€è½¨é“ç®¡ç† | âœ… AudioRecorderController | âœ… AudioMediaStream | 100% |
| æƒé™ç®¡ç† | âœ… éº¦å…‹é£+ç³»ç»ŸéŸ³é¢‘æƒé™ | âœ… æƒé™æ£€æŸ¥ | 100% |
| é”™è¯¯å¤„ç† | âœ… è®¾å¤‡æ–­å¼€å¤„ç† | âœ… è½¨é“é”™è¯¯æ¢å¤ | 100% |

## ğŸ‰ ç»“è®º

**ä½ çš„å½•éŸ³å·¥ç¨‹ä¸æˆ‘ä»¬è®¾è®¡çš„ MediaStream æ¶æ„å®Œç¾åŒ¹é…ï¼**

å®é™…å·¥ç¨‹æä¾›çš„èƒ½åŠ›ï¼š
- âœ… **çº¯éº¦å…‹é£å½•åˆ¶**
- âœ… **ç³»ç»ŸéŸ³é¢‘å½•åˆ¶**ï¼ˆæ”¯æŒç³»ç»Ÿæ··éŸ³å’Œç‰¹å®šè¿›ç¨‹ï¼‰
- âœ… **æ··åˆå½•åˆ¶**ï¼ˆéº¦å…‹é£+ç³»ç»ŸéŸ³é¢‘èåˆåˆ°å•æ–‡ä»¶ï¼‰
- âœ… **åŠ¨æ€å½•åˆ¶å™¨ç®¡ç†**
- âœ… **å®Œæ•´çš„æƒé™å’Œé”™è¯¯å¤„ç†**

è¿™è¯æ˜æˆ‘ä»¬çš„ MediaStream è®¾è®¡ä¸ä»…ç†è®ºä¸Šåˆç†ï¼Œè€Œä¸”ä¸å®é™…å·¥ç¨‹çš„æ¶æ„é«˜åº¦ä¸€è‡´ï¼Œå¯ä»¥ä½œä¸º Web API æ¡¥æ¥å±‚çš„ç†æƒ³åŸºç¡€ï¼



