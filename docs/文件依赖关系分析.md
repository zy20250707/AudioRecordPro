# 文件依赖关系分析

## 一、依赖图

```
┌─────────────────────────────────────────────────────────────────────┐
│                         App 层 (AudioRecordApp)                     │
├─────────────────────────────────────────────────────────────────────┤
│  Controllers/                    Views/                             │
│  ├── MainViewController.swift    ├── MainWindowView.swift           │
│  ├── AudioRecorderController.swift├── SidebarView.swift             │
│  └── AppDelegate.swift           ├── ControlPanelView.swift         │
│                                  ├── TracksView.swift               │
│                                  ├── RecordedFilesView.swift        │
│                                  └── ...                            │
└────────────────────────────────────┬────────────────────────────────┘
                                     │ 依赖
                                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         SDK 层 (AudioRecordKit)                     │
├─────────────────────────────────────────────────────────────────────┤
│  API/ (public)                   Core/ (internal)                   │
│  ├── AudioRecordAPI.swift        ├── Protocols/                     │
│  ├── AudioConstraints.swift      │   └── AudioRecorderProtocol.swift│
│  ├── MediaStream.swift           ├── Recorders/                     │
│  ├── MediaStreamTrack.swift      │   ├── MicrophoneRecorder.swift   │
│  └── AudioRecordError.swift      │   ├── MixedAudioRecorder.swift   │
│                                  │   └── ScreenCaptureAudioRecorder │
│  Utils/ (internal)               ├── ProcessTap/                    │
│  ├── Logger.swift                │   ├── CoreAudioProcessTapRecorder│
│  ├── AudioUtils.swift            │   ├── ProcessTapManager.swift    │
│  ├── PermissionManager.swift     │   └── ...                        │
│  ├── FileManagerUtils.swift      └── Models/                        │
│  └── LevelMonitor.swift              └── AudioRecording.swift       │
└─────────────────────────────────────────────────────────────────────┘
```

## 二、共享类型分析

### 2.1 需要公开的类型 (public)

| 类型 | 当前位置 | 目标位置 | 被引用方 |
|------|----------|----------|----------|
| `RecordingMode` | `AudioUtils.swift` | `API/` | App + SDK |
| `AudioFormat` | `AudioUtils.swift` | `API/` | App + SDK |
| `AudioProcessInfo` | `AudioProcessEnumerator.swift` | `API/` | App + SDK |
| `AudioRecording` | `Models/AudioRecording.swift` | `API/` | App + SDK |
| `RecordingState` | `Views/` 内定义 | `API/` | App + SDK |
| `RecordedFileInfo` | `Views/` 内定义 | `API/` | App |

### 2.2 SDK 内部类型 (internal)

| 类型 | 位置 | 说明 |
|------|------|------|
| `AudioRecorderProtocol` | `Core/Protocols/` | 录制器协议 |
| `BaseAudioRecorder` | `Core/Protocols/` | 基类 |
| `MicrophoneRecorder` | `Core/Recorders/` | 麦克风录制器 |
| `MixedAudioRecorder` | `Core/Recorders/` | 混音录制器 |
| `CoreAudioProcessTapRecorder` | `Core/ProcessTap/` | 系统音频录制器 |
| `Logger` | `Utils/` | 日志工具 |
| `LevelMonitor` | `Utils/` | 电平监控 |

## 三、文件引用详情

### 3.1 RecordingMode 引用链

```
AudioUtils.RecordingMode
    │
    ├── SDK 内部
    │   ├── Recorder/AudioRecorderProtocol.swift
    │   ├── Recorder/MicrophoneRecorder.swift
    │   ├── Recorder/MixedAudioRecorder.swift
    │   ├── Recorder/ScreenCaptureAudioRecorder.swift
    │   ├── ProcessTapRecorder/CoreAudioProcessTapRecorder.swift
    │   ├── Models/AudioRecording.swift
    │   └── Utils/FileManagerUtils.swift
    │
    └── App 层
        ├── Controllers/MainViewController.swift
        ├── Controllers/AudioRecorderController.swift
        └── Views/MainWindowView.swift
```

### 3.2 AudioProcessInfo 引用链

```
AudioProcessInfo
    │
    ├── SDK 内部
    │   ├── ProcessTapRecorder/AudioProcessEnumerator.swift (定义)
    │   └── ProcessTapRecorder/CoreAudioProcessTapRecorder.swift
    │
    └── App 层
        ├── Controllers/MainViewController.swift
        ├── Views/MainWindowView.swift
        ├── Views/SidebarView.swift
        └── Views/TracksView.swift
```

### 3.3 Logger 引用链

```
Logger.shared
    │
    ├── SDK 内部 (17 个文件)
    │   ├── 所有 Recorder/*.swift
    │   ├── 所有 ProcessTapRecorder/*.swift
    │   ├── AudioRecordSDK/AudioRecordAPI.swift
    │   └── 所有 Utils/*.swift
    │
    └── App 层 (5 个文件)
        ├── Controllers/*.swift
        └── Views/RecordedFilesView.swift, SidebarView.swift, WaveformView.swift
```

## 四、迁移策略

### 4.1 第一步：移动共享类型到 API 层

1. 创建 `AudioRecordKit/Sources/API/Types.swift`
2. 移动以下类型：
   - `RecordingMode`
   - `AudioFormat`
   - `AudioProcessInfo`
   - `AudioRecording`
   - `RecordingState`

### 4.2 第二步：移动核心实现到 Core 层

按依赖顺序移动：
1. `Utils/` → `AudioRecordKit/Sources/Utils/`
2. `Models/` → `AudioRecordKit/Sources/Core/Models/`
3. `Recorder/` → `AudioRecordKit/Sources/Core/Recorders/`
4. `ProcessTapRecorder/` → `AudioRecordKit/Sources/Core/ProcessTap/`

### 4.3 第三步：移动 API 层

1. `AudioRecordSDK/*.swift` → `AudioRecordKit/Sources/API/`
2. 调整访问控制为 `public`

### 4.4 第四步：移动 App 层

1. `Controllers/` → `AudioRecordApp/Sources/Controllers/`
2. `Views/` → `AudioRecordApp/Sources/Views/`
3. `main.swift` → `AudioRecordApp/Sources/App/`

## 五、风险点

| 风险 | 说明 | 解决方案 |
|------|------|----------|
| `@MainActor` 污染 | 协议被标记为 `@MainActor` | 移除标记，使用回调 |
| 循环依赖 | App → SDK → Utils → ? | 单向依赖设计 |
| 类型命名冲突 | `RecordingState` 在多处定义 | 统一到 API 层 |

## 六、公开 API 边界

```swift
// AudioRecordKit 公开 API 清单
public class AudioRecordAPI { ... }
public struct AudioConstraints { ... }
public class MediaStream { ... }
public class MediaStreamTrack { ... }
public enum AudioRecordError { ... }

// 公开类型
public enum RecordingMode { ... }
public enum AudioFormat { ... }
public struct AudioProcessInfo { ... }
public struct AudioRecording { ... }
public enum RecordingState { ... }
```


