# AudioRecordMac 项目学习指南 (新版)

## 项目概述

AudioRecordMac 是一个基于 Swift 开发的 macOS 音频录制应用程序，支持多种录制模式：
- 麦克风录制
- 系统音频录制
- 特定应用程序音频录制（CoreAudio Process Tap）

## 核心架构

### 1. 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                    MainViewController                       │
│                     (主控制器)                              │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ Microphone  │ │  SystemAudio│ │ CoreAudio   │
│ Recorder    │ │  Recorder   │ │ ProcessTap  │
│             │ │             │ │ Recorder    │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │             │
        └─────────────┼─────────────┘
                      ▼
                ┌─────────────┐
                │ BaseAudio   │
                │ Recorder    │
                │ (基类)      │
                └─────────────┘
```

### 2. 视图架构 (重构后)

```
┌─────────────────────────────────────────────────────────────┐
│                    MainWindowView                           │
│                   (容器视图)                                │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ SidebarView │ │ TracksView  │ │ControlPanel │
│ (侧边栏)    │ │ (轨道视图)  │ │View(控制)   │
└─────────────┘ └─────────────┘ └─────────────┘
                      │
                      ▼
                ┌─────────────┐
                │StatusBarView│
                │ (状态栏)    │
                └─────────────┘
```

## CoreAudio Process Tap 核心技术

### 1. 技术背景

CoreAudio Process Tap 是 macOS 14.4+ 引入的新 API，允许应用程序直接录制特定进程的音频输出，无需系统级权限。

**核心优势：**
- 无需辅助功能权限
- 无需屏幕录制权限
- 可以精确录制特定应用程序
- 低延迟、高质量

### 2. 实现架构

```
┌─────────────────────────────────────────────────────────────┐
│                CoreAudioProcessTapRecorder                  │
└─────────────────────┬───────────────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│ 进程枚举    │ │ Process Tap │ │ 聚合设备    │
│ (枚举音频   │ │ 创建与管理  │ │ 创建与绑定  │
│  进程列表)  │ │             │ │             │
└─────────────┘ └─────────────┘ └─────────────┘
        │             │             │
        └─────────────┼─────────────┘
                      ▼
                ┌─────────────┐
                │ IO 回调     │
                │ (音频数据   │
                │  处理)      │
                └─────────────┘
```

### 3. 关键实现步骤

#### 步骤 1: 进程枚举与选择
```swift
func getAvailableAudioProcesses() async -> [AudioProcessInfo] {
    // 1. 获取所有音频进程对象
    // 2. 解析进程信息 (PID, 名称, Bundle ID)
    // 3. 返回可选择的进程列表
}
```

#### 步骤 2: Process Tap 创建
```swift
func createProcessTap(for processObjectID: AudioObjectID) -> Bool {
    // 1. 动态加载 AudioHardwareCreateProcessTap 符号
    // 2. 构造 CATapDescription
    // 3. 调用创建 API
    // 4. 保存 Tap 对象 ID
}
```

#### 步骤 3: 流格式读取
```swift
func readTapStreamFormat() -> Bool {
    // 1. 从 Tap 读取 kAudioTapPropertyFormat
    // 2. 解析 AudioStreamBasicDescription
    // 3. 保存格式信息供后续使用
}
```

#### 步骤 4: 聚合设备创建
```swift
func createAggregateDeviceBindingTap() -> Bool {
    // 1. 动态加载 AudioHardwareCreateAggregateDevice
    // 2. 构造聚合设备描述
    // 3. 绑定 Tap 到聚合设备
    // 4. 获取系统默认输出设备
}
```

#### 步骤 5: IO 回调设置
```swift
func setupIOProcAndStart() -> Bool {
    // 1. 创建 IO 回调函数
    // 2. 安装到聚合设备
    // 3. 启动设备开始录制
}
```

### 4. 核心技术细节

#### 动态符号加载
```swift
// 由于这些 API 在公共 SDK 中不可用，需要动态加载
let handle = dlopen(nil, RTLD_NOW)
guard let sym = dlsym(handle, "AudioHardwareCreateProcessTap") else {
    return false
}
let createTap = unsafeBitCast(sym, to: CreateTapFn.self)
```

#### CATapDescription 构造
```swift
var desc = CATapDescription(stereoMixdownOfProcesses: [processObjectID])
desc.uuid = uuid
desc.muteBehavior = .unmuted
```

#### 聚合设备配置
```swift
let description: [String: Any] = [
    kAudioAggregateDeviceNameKey: "Tap-\(tapUUID)",
    kAudioAggregateDeviceUIDKey: aggregateUID,
    kAudioAggregateDeviceMainSubDeviceKey: outputUID,
    kAudioAggregateDeviceIsPrivateKey: true,
    kAudioAggregateDeviceTapAutoStartKey: true,
    // ...
]
```

### 5. 音频数据流

```
目标进程音频输出
        ↓
   Process Tap
        ↓
   聚合设备 (Aggregate Device)
        ↓
   IO 回调函数
        ↓
   音频文件写入
```

## 权限管理

### 1. 权限类型
- **麦克风权限**: 录制麦克风输入
- **屏幕录制权限**: 传统系统音频录制 (ScreenCaptureKit)
- **CoreAudio Process Tap**: 无需额外权限 (macOS 14.4+)

### 2. 权限检查流程
```swift
class PermissionManager {
    func checkMicrophonePermission() -> Bool
    func checkScreenRecordingPermission() -> Bool
    func requestMicrophonePermission()
    func requestScreenRecordingPermission()
}
```

## 文件结构详解

### 核心控制器
```
src/Controllers/
├── MainViewController.swift          # 主控制器，协调各个组件
├── AudioRecorderController.swift     # 录音控制器基类
├── AudioRecorderProtocol.swift       # 录音器协议定义
├── MicrophoneRecorder.swift          # 麦克风录制器
├── SystemAudioRecorder.swift         # 系统音频录制器
└── CoreAudioProcessTapRecorder.swift # CoreAudio Process Tap 录制器
```

### 视图组件 (重构后)
```
src/Views/
├── MainWindowView.swift              # 主窗口容器视图
├── SidebarView.swift                 # 侧边栏 (音频源选择)
├── TracksView.swift                  # 轨道显示视图
├── ControlPanelView.swift            # 控制面板 (录音按钮)
├── StatusBarView.swift               # 状态栏
└── LevelMeterView.swift              # 电平表视图
```

### 工具类
```
src/Utils/
├── AudioUtils.swift                  # 音频工具类
├── FileManagerUtils.swift            # 文件管理工具
├── LevelMonitor.swift                # 电平监控
├── Logger.swift                      # 日志工具
└── PermissionManager.swift           # 权限管理
```

### 数据模型
```
src/Models/
└── AudioRecording.swift              # 录音数据模型
```

## 关键设计模式

### 1. 策略模式
不同的录制器实现相同的协议，可以根据需要切换：
```swift
protocol AudioRecorderProtocol {
    func startRecording()
    func stopRecording()
    // ...
}
```

### 2. 委托模式
视图与控制器之间通过委托进行通信：
```swift
protocol MainWindowViewDelegate: AnyObject {
    func mainWindowViewDidStartRecording(_ view: MainWindowView)
    func mainWindowViewDidStopRecording(_ view: MainWindowView)
    // ...
}
```

### 3. 观察者模式
通过回调函数通知状态变化：
```swift
var onStatus: ((String) -> Void)?
var onLevel: ((Float) -> Void)?
```

## 构建与部署

### 1. 构建脚本
```bash
./build.sh
```

构建过程包括：
1. 清理旧构建
2. 复制源码
3. 编译 Swift 源码
4. 复制资源文件
5. 代码签名

### 2. 代码签名
使用 `AudioRecordMac.entitlements` 进行签名，包含必要的权限：
```xml
<key>com.apple.security.device.audio-input</key>
<key>com.apple.security.device.camera</key>
<key>com.apple.security.files.user-selected.read-write</key>
```

## 技术挑战与解决方案

### 1. 动态 API 加载
**挑战**: CoreAudio Process Tap API 不在公共 SDK 中
**解决**: 使用 `dlsym` 动态加载符号

### 2. 进程枚举
**挑战**: 获取所有可录制的音频进程
**解决**: 通过 CoreAudio 对象属性枚举

### 3. 聚合设备管理
**挑战**: 创建和管理虚拟音频设备
**解决**: 使用 CoreAudio 聚合设备 API

### 4. 权限处理
**挑战**: 不同录制模式需要不同权限
**解决**: 统一的权限管理类

## 扩展方向

### 1. 功能扩展
- 实时音频处理
- 多轨道录制
- 音频格式转换
- 云端存储集成

### 2. 性能优化
- 内存使用优化
- CPU 使用率优化
- 延迟优化

### 3. 用户体验
- 更丰富的 UI 组件
- 快捷键支持
- 主题定制

## 学习建议

### 1. 核心学习路径
1. 理解 macOS 音频架构
2. 学习 CoreAudio 基础 API
3. 掌握 Process Tap 技术
4. 了解权限管理机制
5. 学习 Swift 和 Cocoa 开发

### 2. 实践建议
1. 从简单的麦克风录制开始
2. 逐步学习系统音频录制
3. 深入理解 Process Tap 实现
4. 尝试添加新功能

### 3. 调试技巧
1. 使用日志系统跟踪执行流程
2. 利用 Xcode 调试器
3. 监控音频设备状态
4. 检查权限状态

## 总结

AudioRecordMac 项目展示了现代 macOS 音频录制的完整解决方案，特别是 CoreAudio Process Tap 的创新应用。通过组件化架构和清晰的职责分离，项目具有良好的可维护性和扩展性。

CoreAudio Process Tap 技术为 macOS 音频录制开辟了新的可能性，无需复杂的权限配置即可实现高质量的应用程序音频录制，是未来 macOS 音频应用开发的重要方向。
